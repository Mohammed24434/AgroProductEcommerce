@model List<ApplicationUser>
@{
    ViewData["Title"] = "KYC Management";
    Layout = "_Layout";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>KYC Management</h2>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary" onclick="exportKYCData()">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                    <button class="btn btn-outline-secondary" onclick="refreshKYCData()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
            </div>

            <!-- KYC Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <h5 class="card-title">Pending Review</h5>
                            <h3>@Model.Count(u => u.KYCStatus == KYCStatus.Pending)</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h5 class="card-title">Approved</h5>
                            <h3>@Model.Count(u => u.KYCStatus == KYCStatus.Approved)</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <h5 class="card-title">Rejected</h5>
                            <h3>@Model.Count(u => u.KYCStatus == KYCStatus.Rejected)</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <h5 class="card-title">Total Users</h5>
                            <h3>@Model.Count</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">KYC Status</label>
                            <select class="form-select" id="kycStatusFilter">
                                <option value="">All Status</option>
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                                <option value="NotSubmitted">Not Submitted</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">User Type</label>
                            <select class="form-select" id="userTypeFilter">
                                <option value="">All Types</option>
                                <option value="Supplier">Supplier</option>
                                <option value="Buyer">Buyer</option>
                                <option value="Both">Both</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Registration Date</label>
                            <select class="form-select" id="dateFilter">
                                <option value="">All Dates</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Search</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search users...">
                        </div>
                    </div>
                </div>
            </div>

            <!-- KYC Users Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="kycTable">
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>User Info</th>
                                    <th>Business Details</th>
                                    <th>KYC Status</th>
                                    <th>Documents</th>
                                    <th>Registration Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var user in Model)
                                {
                                    <tr>
                                        <td>
                                            <strong>#@user.Id</strong>
                                            @if (user.KYCStatus == KYCStatus.Approved)
                                            {
                                                <span class="badge bg-success ms-1">Verified</span>
                                            }
                                        </td>
                                        <td>
                                            <div class="fw-bold">@user.UserName</div>
                                            <div class="text-muted">@user.Email</div>
                                            <div class="text-muted">@user.PhoneNumber</div>
                                            <div class="badge bg-@(user.UserType == UserType.Supplier ? "primary" : user.UserType == UserType.Buyer ? "success" : "warning")">
                                                @user.UserType
                                            </div>
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(user.CompanyName))
                                            {
                                                <div class="fw-bold">@user.CompanyName</div>
                                                <div class="text-muted">@user.BusinessRegistrationNumber</div>
                                                <div class="text-muted">@user.Country</div>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Not provided</span>
                                            }
                                        </td>
                                        <td>
                                            <span class="badge bg-@(user.KYCStatus == KYCStatus.Approved ? "success" : user.KYCStatus == KYCStatus.Rejected ? "danger" : user.KYCStatus == KYCStatus.Pending ? "warning" : "secondary")">
                                                @user.KYCStatus
                                            </span>
                                            @if (user.KYCStatus == KYCStatus.Pending)
                                            {
                                                <div class="text-muted small">Pending review</div>
                                            }
                                        </td>
                                        <td>
                                            @if (user.KYCStatus != KYCStatus.NotSubmitted)
                                            {
                                                <div class="btn-group-vertical btn-group-sm">
                                                    @if (user.KYCStatus == KYCStatus.Approved)
                                                    {
                                                        <span class="badge bg-success">Approved</span>
                                                        <small class="text-muted">@user.KYCVerifiedDate?.ToString("MMM dd, yyyy")</small>
                                                        @if (!string.IsNullOrEmpty(user.KYCVerifiedBy))
                                                        {
                                                            <small class="text-muted">by @user.KYCVerifiedBy</small>
                                                        }
                                                    }
                                                    else if (user.KYCStatus == KYCStatus.Rejected)
                                                    {
                                                        <span class="badge bg-danger">Rejected</span>
                                                        @if (!string.IsNullOrEmpty(user.KYCRejectionReason))
                                                        {
                                                            <small class="text-muted">@user.KYCRejectionReason</small>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-warning">@user.KYCStatus</span>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Not submitted</span>
                                            }
                                        </td>
                                        <td>
                                            <div>@user.RegistrationDate.ToString("MMM dd, yyyy")</div>
                                            <small class="text-muted">@user.RegistrationDate.ToString("HH:mm")</small>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary" onclick="viewKYCDetails('@user.Id')">
                                                    <i class="fas fa-eye"></i> View
                                                </button>
                                                @if (user.KYCStatus == KYCStatus.Pending)
                                                {
                                                    <button class="btn btn-sm btn-outline-success" onclick="approveKYC('@user.Id')">
                                                        <i class="fas fa-check"></i> Approve
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" onclick="rejectKYC('@user.Id')">
                                                        <i class="fas fa-times"></i> Reject
                                                    </button>
                                                }
                                                <button class="btn btn-sm btn-outline-warning" onclick="requestMoreInfo('@user.Id')">
                                                    <i class="fas fa-question"></i> Request Info
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- KYC Details Modal -->
<div class="modal fade" id="kycDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">KYC Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="kycDetails">
                <!-- KYC details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Document Viewer Modal -->
<div class="modal fade" id="documentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="documentTitle">Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="documentViewer">
                    <!-- Document will be displayed here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Request More Info Modal -->
<div class="modal fade" id="requestInfoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Request Additional Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="requestInfoForm">
                <div class="modal-body">
                    <input type="hidden" id="requestUserId" name="userId">
                    <div class="mb-3">
                        <label class="form-label">Subject</label>
                        <input type="text" class="form-control" name="subject" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message</label>
                        <textarea class="form-control" name="message" rows="5" required 
                                  placeholder="Please specify what additional information is needed..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Required Documents</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="requiredDocs" value="identity">
                            <label class="form-check-label">Identity Document</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="requiredDocs" value="business">
                            <label class="form-check-label">Business License</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="requiredDocs" value="bank">
                            <label class="form-check-label">Bank Statement</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="requiredDocs" value="address">
                            <label class="form-check-label">Proof of Address</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Request</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Filter functionality
        $('#kycStatusFilter, #userTypeFilter, #dateFilter').change(function() {
            filterKYC();
        });

        $('#searchInput').on('input', function() {
            filterKYC();
        });

        function filterKYC() {
            const status = $('#kycStatusFilter').val();
            const userType = $('#userTypeFilter').val();
            const dateFilter = $('#dateFilter').val();
            const search = $('#searchInput').val().toLowerCase();

            $('#kycTable tbody tr').each(function() {
                let show = true;
                const row = $(this);
                const userName = row.find('td:nth-child(2) .fw-bold').text().toLowerCase();
                const userEmail = row.find('td:nth-child(2) .text-muted').first().text().toLowerCase();
                const userTypeText = row.find('td:nth-child(2) .badge').text();
                const kycStatus = row.find('td:nth-child(4) .badge').text();
                const regDate = new Date(row.find('td:nth-child(6) div').text());

                if (status && kycStatus !== status) show = false;
                if (userType && userTypeText !== userType) show = false;
                if (search && !userName.includes(search) && !userEmail.includes(search)) show = false;
                if (dateFilter) {
                    const today = new Date();
                    const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    const startOfWeek = new Date(today.getFullYear(), today.getMonth(), today.getDate() - today.getDay());
                    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    const startOfQuarter = new Date(today.getFullYear(), Math.floor(today.getMonth() / 3) * 3, 1);

                    let validDate = false;
                    switch(dateFilter) {
                        case 'today':
                            validDate = regDate >= startOfDay;
                            break;
                        case 'week':
                            validDate = regDate >= startOfWeek;
                            break;
                        case 'month':
                            validDate = regDate >= startOfMonth;
                            break;
                        case 'quarter':
                            validDate = regDate >= startOfQuarter;
                            break;
                    }
                    if (!validDate) show = false;
                }

                row.toggle(show);
            });
        }

        function viewKYCDetails(userId) {
            $.get(`/Admin/KYCDetails/${userId}`, function(data) {
                $('#kycDetails').html(data);
                $('#kycDetailsModal').modal('show');
            });
        }

        function approveKYC(userId) {
            if (confirm('Are you sure you want to approve this KYC application?')) {
                $.post(`/Admin/ApproveKYC/${userId}`, function(result) {
                    if (result.success) {
                        location.reload();
                    } else {
                        alert('Error approving KYC');
                    }
                });
            }
        }

        function rejectKYC(userId) {
            const reason = prompt('Please provide a reason for rejection:');
            if (reason) {
                $.post(`/Admin/RejectKYC/${userId}`, { reason: reason }, function(result) {
                    if (result.success) {
                        location.reload();
                    } else {
                        alert('Error rejecting KYC');
                    }
                });
            }
        }

        function viewDocument(documentUrl, documentType) {
            $('#documentTitle').text(documentType);
            $('#documentViewer').html(`
                <div class="text-center">
                    <iframe src="${documentUrl}" width="100%" height="500px" frameborder="0"></iframe>
                    <div class="mt-3">
                        <a href="${documentUrl}" target="_blank" class="btn btn-primary">
                            <i class="fas fa-download"></i> Download
                        </a>
                    </div>
                </div>
            `);
            $('#documentModal').modal('show');
        }

        function requestMoreInfo(userId) {
            $('#requestUserId').val(userId);
            $('#requestInfoModal').modal('show');
        }

        $('#requestInfoForm').submit(function(e) {
            e.preventDefault();
            const formData = $(this).serialize();
            
            $.post('/Admin/RequestMoreInfo', formData, function(result) {
                if (result.success) {
                    $('#requestInfoModal').modal('hide');
                    alert('Information request sent successfully');
                } else {
                    alert('Error sending request');
                }
            });
        });

        function exportKYCData() {
            const filters = {
                status: $('#kycStatusFilter').val(),
                userType: $('#userTypeFilter').val(),
                dateFilter: $('#dateFilter').val(),
                search: $('#searchInput').val()
            };

            $.post('/Admin/ExportKYCData', filters, function(result) {
                if (result.success) {
                    window.open(result.downloadUrl, '_blank');
                } else {
                    alert('Error exporting data');
                }
            });
        }

        function refreshKYCData() {
            location.reload();
        }
    </script>
} 