@model List<RFQ>
@{
    ViewData["Title"] = "My RFQs";
    Layout = "_Layout";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>My Request for Quotations</h2>
                <a href="@Url.Action("CreateRFQ", "Buyer")" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Create New RFQ
                </a>
            </div>

            <!-- RFQ Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h5 class="card-title">Total RFQs</h5>
                            <h3>@Model.Count</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h5 class="card-title">Active RFQs</h5>
                            <h3>@Model.Count(r => r.Status == RFQStatus.Open)</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <h5 class="card-title">Responses Received</h5>
                            <h3>@Model.Sum(r => r.Responses?.Count ?? 0)</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <h5 class="card-title">Expiring Soon</h5>
                            <h3>@Model.Count(r => r.Deadline <= DateTime.Now.AddDays(7) && r.Status == RFQStatus.Open)</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="Open">Open</option>
                                <option value="Closed">Closed</option>
                                <option value="Awarded">Awarded</option>
                                <option value="Expired">Expired</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="categoryFilter">
                                <option value="">All Categories</option>
                                <option value="Grains">Grains</option>
                                <option value="Vegetables">Vegetables</option>
                                <option value="Fruits">Fruits</option>
                                <option value="Spices">Spices</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Budget Range</label>
                            <select class="form-select" id="budgetFilter">
                                <option value="">All Budgets</option>
                                <option value="0-1000">$0 - $1,000</option>
                                <option value="1000-5000">$1,000 - $5,000</option>
                                <option value="5000-10000">$5,000 - $10,000</option>
                                <option value="10000+">$10,000+</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Search</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search RFQs...">
                        </div>
                    </div>
                </div>
            </div>

            <!-- RFQs List -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="rfqsTable">
                            <thead>
                                <tr>
                                    <th>RFQ ID</th>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Budget</th>
                                    <th>Deadline</th>
                                    <th>Status</th>
                                    <th>Responses</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var rfq in Model)
                                {
                                    <tr>
                                        <td>
                                            <strong>#@rfq.Id</strong>
                                            @if (rfq.Deadline.HasValue && rfq.Deadline <= DateTime.Now.AddDays(3))
                                            {
                                                <span class="badge bg-danger ms-1">Urgent</span>
                                            }
                                        </td>
                                        <td>
                                            <div class="fw-bold">@rfq.Title</div>
                                            <small class="text-muted">@rfq.Description.Substring(0, Math.Min(50, rfq.Description.Length))...</small>
                                        </td>
                                        <td>@rfq.Category</td>
                                        <td>
                                            <div class="fw-bold">@(rfq.Budget?.ToString("C") ?? "Not specified")</div>
                                            <small class="text-muted">@(rfq.BudgetCurrency ?? "USD")</small>
                                        </td>
                                        <td>
                                            <div class="@(rfq.Deadline?.Date <= DateTime.Now.AddDays(7) ? "text-danger" : "")">
                                                @(rfq.Deadline?.ToString("MMM dd, yyyy") ?? "No deadline")
                                            </div>
                                            <small class="text-muted">
                                                @if (rfq.Deadline.HasValue && rfq.Deadline > DateTime.Now)
                                                {
                                                    var daysLeft = (rfq.Deadline.Value - DateTime.Now).Days;
                                                    @($"{daysLeft} days left")
                                                }
                                                else if (rfq.Deadline.HasValue)
                                                {
                                                    @("Expired")
                                                }
                                                else
                                                {
                                                    @("No deadline")
                                                }
                                            </small>
                                        </td>
                                        <td>
                                            <span class="badge bg-@(rfq.Status == RFQStatus.Open ? "success" : rfq.Status == RFQStatus.Expired ? "secondary" : rfq.Status == RFQStatus.Awarded ? "primary" : "warning")">
                                                @rfq.Status
                                            </span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <span class="badge bg-info me-2">@(rfq.Responses?.Count ?? 0)</span>
                                                @if (rfq.Responses?.Any() == true)
                                                {
                                                    <span class="badge bg-warning">Responses</span>
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary" onclick="viewRFQ(@rfq.Id)">
                                                    <i class="fas fa-eye"></i> View
                                                </button>
                                                @if (rfq.Status == RFQStatus.Open)
                                                {
                                                    <button class="btn btn-sm btn-outline-warning" onclick="editRFQ(@rfq.Id)">
                                                        <i class="fas fa-edit"></i> Edit
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" onclick="closeRFQ(@rfq.Id)">
                                                        <i class="fas fa-times"></i> Close
                                                    </button>
                                                }
                                                @if (rfq.Responses?.Any() == true)
                                                {
                                                    <button class="btn btn-sm btn-outline-success" onclick="viewResponses(@rfq.Id)">
                                                        <i class="fas fa-reply"></i> Responses
                                                    </button>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View RFQ Modal -->
<div class="modal fade" id="viewRFQModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">RFQ Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="rfqDetails">
                <!-- RFQ details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- View Responses Modal -->
<div class="modal fade" id="viewResponsesModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">RFQ Responses</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="responsesDetails">
                <!-- Responses will be loaded here -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Filter functionality
        $('#statusFilter, #categoryFilter, #budgetFilter').change(function() {
            filterRFQs();
        });

        $('#searchInput').on('input', function() {
            filterRFQs();
        });

        function filterRFQs() {
            const status = $('#statusFilter').val();
            const category = $('#categoryFilter').val();
            const budget = $('#budgetFilter').val();
            const search = $('#searchInput').val().toLowerCase();

            $('#rfqsTable tbody tr').each(function() {
                let show = true;
                const row = $(this);
                const rfqTitle = row.find('td:nth-child(2) .fw-bold').text().toLowerCase();
                const rfqCategory = row.find('td:nth-child(3)').text();
                const rfqStatus = row.find('td:nth-child(6) .badge').text();
                const budgetText = row.find('td:nth-child(4) .fw-bold').text();

                if (status && rfqStatus !== status) show = false;
                if (category && rfqCategory !== category) show = false;
                if (search && !rfqTitle.includes(search)) show = false;
                if (budget) {
                    const budgetValue = parseFloat(budgetText.replace(/[^0-9.]/g, ''));
                    if (budget === '0-1000' && (budgetValue < 0 || budgetValue > 1000)) show = false;
                    if (budget === '1000-5000' && (budgetValue < 1000 || budgetValue > 5000)) show = false;
                    if (budget === '5000-10000' && (budgetValue < 5000 || budgetValue > 10000)) show = false;
                    if (budget === '10000+' && budgetValue < 10000) show = false;
                }

                row.toggle(show);
            });
        }

        function viewRFQ(rfqId) {
            $.get(`/Buyer/RFQDetails/${rfqId}`, function(data) {
                $('#rfqDetails').html(data);
                $('#viewRFQModal').modal('show');
            });
        }

        function editRFQ(rfqId) {
            window.location.href = `/Buyer/EditRFQ/${rfqId}`;
        }

        function closeRFQ(rfqId) {
            if (confirm('Are you sure you want to close this RFQ? This action cannot be undone.')) {
                $.post(`/Buyer/CloseRFQ/${rfqId}`, function(result) {
                    if (result.success) {
                        location.reload();
                    } else {
                        alert('Error closing RFQ');
                    }
                });
            }
        }

        function viewResponses(rfqId) {
            $.get(`/Buyer/RFQResponses/${rfqId}`, function(data) {
                $('#responsesDetails').html(data);
                $('#viewResponsesModal').modal('show');
            });
        }

        function awardRFQ(rfqId, responseId) {
            if (confirm('Are you sure you want to award this RFQ to the selected supplier?')) {
                $.post(`/Buyer/AwardRFQ/${rfqId}/${responseId}`, function(result) {
                    if (result.success) {
                        $('#viewResponsesModal').modal('hide');
                        location.reload();
                    } else {
                        alert('Error awarding RFQ');
                    }
                });
            }
        }

        function contactSupplier(supplierId) {
            window.location.href = `/Messaging/Conversation/${supplierId}`;
        }
    </script>
} 